name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - '**.md'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check markdown files
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/build/**
      
      - name: Check links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true
      
      - name: Spell check
        uses: rojopolis/spellcheck-github-actions@0.56.0
        with:
          config_path: '.github/spellcheck.yml'
        continue-on-error: true
  
  generate-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Generate Dokka documentation
        run: |
          # Add Dokka task if available
          ./gradlew dokkaHtml || echo "Dokka not configured"
      
      - name: Upload documentation
        uses: actions/upload-artifact@v6
        with:
          name: api-docs
          path: app/build/dokka/
          retention-days: 30
        continue-on-error: true
  
  check-readme:
    name: Check README Completeness
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check README sections
        run: |
          echo "Checking README.md for required sections..."
          
          REQUIRED_SECTIONS=(
            "Overview"
            "Features"
            "Installation"
            "Getting Started"
            "Documentation"
            "Contributing"
            "License"
          )
          
          MISSING_SECTIONS=()
          
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -qi "^#.*$section" README.md; then
              MISSING_SECTIONS+=("$section")
            fi
          done
          
          if [ ${#MISSING_SECTIONS[@]} -eq 0 ]; then
            echo "✅ All required sections are present in README.md"
          else
            echo "⚠️ Missing sections in README.md:"
            printf '%s\n' "${MISSING_SECTIONS[@]}"
          fi
      
      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links in README.md..."
          
          # Extract markdown links
          grep -o '\[.*\](\.\/.*\.md)' README.md | grep -o '(\.\/.*\.md)' | tr -d '()' | while read -r link; do
            if [ ! -f "$link" ]; then
              echo "⚠️ Broken link: $link"
            fi
          done
          
          echo "✅ Internal link check complete"
